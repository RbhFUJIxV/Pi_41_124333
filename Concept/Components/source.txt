@startuml
!define RECTANGLE class
hide circle
hide empty members

skinparam class {
    BackgroundColor White
    BorderColor Black
    ArrowColor Black
    FontSize 12
}

skinparam componentStyle rectangle

' Основные документы данных

package "Основные игровые данные" {
  RECTANGLE "PlayerProfile" as PlayerProfile {
    + player_id: UUID (PK)
    + username: String
    + email: String
    + playstyle: Enum
    + created_at: DateTime
    + preferences: JSON
    + privacy_settings: JSON
    + consent_given: Boolean
  }
  
  RECTANGLE "GameSession" as GameSession {
    + session_id: UUID (PK)
    + player_id: UUID (FK)
    + started_at: DateTime
    + last_activity: DateTime
    + current_scene: String
    + game_state: JSON
    + narrative_context: JSON
    + ai_context_cache_key: String
  }
  
  RECTANGLE "CharacterProfile" as CharacterProfile {
    + character_id: UUID (PK)
    + name: String
    + personality_profile: JSON
    + backstory: JSON
    + voice_profile: JSON
    + visual_profile: JSON
    + ai_model_id: UUID (FK)
    + base_prompt_template: JSON
  }
  
  RECTANGLE "GameProgress" as GameProgress {
    + progress_id: UUID (PK)
    + player_id: UUID (FK)
    + character_id: UUID (FK)
    + completed_scenes: Array<String>
    + unlocked_endings: Array<String>
    + achievements: JSON
    + play_time_hours: Float
    + decisions_made: Integer
  }
  
  RECTANGLE "RelationshipState" as RelationshipState {
    + relationship_id: UUID (PK)
    + player_id: UUID (FK)
    + character_id: UUID (FK)
    + trust_level: Integer
    + friendship_level: Integer
    + romance_level: Integer
    + memory_flags: JSON
    + last_updated: DateTime
    + relationship_history: JSON
  }
}

package "AI и контент" {
  RECTANGLE "AIModelConfig" as AIModelConfig {
    + model_id: UUID (PK)
    + model_name: String
    + provider: String
    + model_type: Enum
    + version: String
    + capabilities: JSON
    + cost_per_token: Float
    + latency_ms: Integer
    + prompt_templates: JSON
    + safety_filters: JSON
  }
  
  RECTANGLE "ContentCache" as ContentCache {
    + cache_key: String (PK)
    + prompt_hash: String
    + ai_response: JSON
    + generated_at: DateTime
    + expires_at: DateTime
    + hit_count: Integer
    + last_accessed: DateTime
    + context_similarity_score: Float
  }
  
  RECTANGLE "NarrativeLog" as NarrativeLog {
    + log_id: UUID (PK)
    + session_id: UUID (FK)
    + character_id: UUID (FK)
    + player_id: UUID (FK)
    + event_type: Enum
    + event_data: JSON
    + ai_prompt_used: JSON
    + ai_response_raw: JSON
    + timestamp: DateTime
    + vector_embedding: Array<Float>
  }
}

package "Безопасность и аналитика" {
  RECTANGLE "SecurityAuditLog" as SecurityAuditLog {
    + audit_id: UUID (PK)
    + timestamp: DateTime
    + user_id: UUID
    + action_type: String
    + resource: String
    + details: JSON
    + ip_address: String
    + ai_model_used: String
    + content_moderation_result: JSON
  }
  
  RECTANGLE "AnalyticsData" as AnalyticsData {
    + analytics_id: UUID (PK)
    + player_id: UUID (FK)
    + session_id: UUID (FK)
    + metric_name: String
    + metric_value: JSON
    + timestamp: DateTime
    + aggregation_level: String
    + derived_insights: JSON
  }
}

' Связи между документами

PlayerProfile "1" -- "0..*" GameSession : creates
PlayerProfile "1" -- "0..*" RelationshipState : has
PlayerProfile "1" -- "0..*" GameProgress : tracks
PlayerProfile "1" -- "0..*" SecurityAuditLog : generates
PlayerProfile "1" -- "0..*" AnalyticsData : produces

GameSession "1" -- "0..*" NarrativeLog : contains
GameSession "1" -- "1..*" ContentCache : references

CharacterProfile "1" -- "0..*" NarrativeLog : participates_in
CharacterProfile "1" -- "0..*" RelationshipState : involved_in
CharacterProfile "1" -- "0..*" GameProgress : appears_in
CharacterProfile "1" -- "1" AIModelConfig : uses

AIModelConfig "1" -- "0..*" NarrativeLog : generates
AIModelConfig "1" -- "0..*" ContentCache : fills
AIModelConfig "1" -- "0..*" SecurityAuditLog : associated_with

NarrativeLog "1" -- "0..*" AnalyticsData : contributes_to

RelationshipState "1" -- "1" GameProgress : influences

note top of PlayerProfile
  Основной профиль игрока.
  Содержит настройки, предпочтения
  и согласие на обработку данных.
end note

note right of AIModelConfig
  Конфигурация AI-моделей.
  Включает промпт-шаблоны,
  настройки безопасности
  и метрики стоимости/производительности.
end note

note left of NarrativeLog
  Детальная история всех событий.
  Хранит как сырые данные AI,
  так и векторные эмбеддинги
  для семантического поиска.
end note

@enduml
